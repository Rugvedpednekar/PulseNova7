<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseNova - AI Medical Assistant</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ===== VOICE OVERLAY ===== */
        .voice-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 1000;
            display: none;
            color: white;
        }
        .voice-overlay.show { display: flex; }

        /* Orb */
        .voice-orb-wrap {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto;
        }

        .voice-orb {
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            background: radial-gradient(circle at 32% 28%, #60a5fa, #2563eb 50%, #0f172a 100%);
            box-shadow:
                0 0 40px rgba(59,130,246,0.5),
                0 0 90px rgba(59,130,246,0.25),
                inset 0 0 30px rgba(255,255,255,0.12);
            transform: scale(1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* State-based orb animations */
        .voice-orb.state-idle {
            animation: none;
            transform: scale(0.95);
            opacity: 0.6;
        }
        .voice-orb.state-listening {
            animation: orbListening 1.1s infinite ease-in-out;
        }
        .voice-orb.state-thinking {
            animation: orbThinking 1.8s infinite ease-in-out;
            background: radial-gradient(circle at 32% 28%, #a78bfa, #7c3aed 50%, #0f172a 100%);
            box-shadow: 0 0 40px rgba(139,92,246,0.5), 0 0 90px rgba(139,92,246,0.25), inset 0 0 30px rgba(255,255,255,0.12);
        }
        .voice-orb.state-speaking {
            animation: orbSpeaking 0.7s infinite ease-in-out;
            background: radial-gradient(circle at 32% 28%, #6ee7b7, #10b981 50%, #0f172a 100%);
            box-shadow: 0 0 40px rgba(16,185,129,0.5), 0 0 90px rgba(16,185,129,0.25), inset 0 0 30px rgba(255,255,255,0.12);
        }

        @keyframes orbListening {
            0%, 100% { transform: scale(0.97); box-shadow: 0 0 30px rgba(59,130,246,0.4), 0 0 60px rgba(59,130,246,0.15); }
            50% { transform: scale(1.05); box-shadow: 0 0 60px rgba(59,130,246,0.7), 0 0 110px rgba(59,130,246,0.3); }
        }
        @keyframes orbThinking {
            0%, 100% { transform: scale(0.96); opacity: 0.85; }
            50% { transform: scale(1.03); opacity: 1; }
        }
        @keyframes orbSpeaking {
            0%, 100% { transform: scale(1.00); }
            20% { transform: scale(1.07); }
            40% { transform: scale(1.03); }
            60% { transform: scale(1.09); }
            80% { transform: scale(1.04); }
        }

        /* Rings */
        .voice-rings {
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            pointer-events: none;
        }
        .voice-rings::before,
        .voice-rings::after {
            content: "";
            position: absolute;
            border-radius: 9999px;
            border: 1px solid rgba(96,165,250,0.3);
            animation: voiceRing 2.2s infinite ease-out;
        }
        .voice-rings::before { inset: -20px; }
        .voice-rings::after { inset: -38px; animation-delay: 0.7s; opacity: 0.6; }
        .voice-orb.state-thinking ~ .voice-rings::before,
        .voice-orb.state-thinking ~ .voice-rings::after {
            border-color: rgba(167,139,250,0.3);
        }
        .voice-orb.state-speaking ~ .voice-rings::before,
        .voice-orb.state-speaking ~ .voice-rings::after {
            border-color: rgba(16,185,129,0.35);
        }
        @keyframes voiceRing {
            0% { transform: scale(0.93); opacity: 0.6; }
            100% { transform: scale(1.18); opacity: 0; }
        }

        /* Waveform bars */
        .voice-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 5px;
            height: 48px;
        }
        .voice-bars span {
            width: 6px;
            border-radius: 999px;
            background: linear-gradient(to top, #2563eb, #38bdf8);
            height: 6px;
            transition: height 80ms linear, opacity 80ms linear, background 400ms;
        }
        .voice-bars.speaking span {
            background: linear-gradient(to top, #10b981, #6ee7b7);
        }
        .voice-bars.thinking span {
            background: linear-gradient(to top, #7c3aed, #a78bfa);
            animation: barPulse 1.8s infinite ease-in-out;
        }
        @keyframes barPulse {
            0%, 100% { opacity: 0.4; height: 4px !important; }
            50% { opacity: 1; height: 14px !important; }
        }

        /* Drag-and-drop */
        .drag-active {
            border-color: #3b82f6 !important;
            background: #eff6ff !important;
        }
        .drag-active-purple {
            border-color: #a855f7 !important;
            background: #faf5ff !important;
        }
    </style>
</head>
<body class="bg-white text-slate-900 selection:bg-blue-100 selection:text-blue-900 flex flex-col min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2 cursor-pointer" onclick="app.navigate('home')">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="text-xl font-bold bg-gradient-to-r from-blue-700 to-cyan-600 bg-clip-text text-transparent">
                        PulseNova
                    </span>
                </div>

                <div class="hidden md:flex space-x-1">
                    <button onclick="app.navigate('home')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="home">
                        <i data-lucide="brain" class="w-4 h-4"></i> Home
                    </button>
                    <button onclick="app.navigate('triage')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="triage">
                        <i data-lucide="message-square" class="w-4 h-4"></i> Triage
                    </button>
                    <button onclick="app.navigate('vitals')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="vitals">
                        <i data-lucide="heart-pulse" class="w-4 h-4"></i> Vitals
                    </button>
                    <button onclick="app.navigate('xray')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="xray">
                        <i data-lucide="scan-line" class="w-4 h-4"></i> X-Ray
                    </button>
                    <button onclick="app.navigate('labs')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="labs">
                        <i data-lucide="microscope" class="w-4 h-4"></i> Lab Translator
                    </button>
                    <button onclick="app.navigate('care')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="care">
                        <i data-lucide="map-pin" class="w-4 h-4"></i> Find Care
                    </button>
                    <button onclick="app.navigate('about')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50" data-page="about">
                        <i data-lucide="info" class="w-4 h-4"></i> About
                    </button>
                </div>

                <button class="md:hidden text-slate-600 p-2" onclick="app.toggleMobileMenu()">
                    <i data-lucide="menu" id="menu-icon"></i>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100 py-2 shadow-lg absolute w-full left-0 top-16 z-40">
            <button onclick="app.navigate('home')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="brain" class="w-4 h-4"></i> Home</button>
            <button onclick="app.navigate('triage')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="message-square" class="w-4 h-4"></i> Triage</button>
            <button onclick="app.navigate('vitals')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="heart-pulse" class="w-4 h-4"></i> Vitals</button>
            <button onclick="app.navigate('xray')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="scan-line" class="w-4 h-4"></i> X-Ray</button>
            <button onclick="app.navigate('labs')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="microscope" class="w-4 h-4"></i> Labs</button>
            <button onclick="app.navigate('care')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="map-pin" class="w-4 h-4"></i> Care Finder</button>
            <button onclick="app.navigate('about')" class="block w-full text-left px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-3"><i data-lucide="info" class="w-4 h-4"></i> About</button>
        </div>
    </nav>

    <main id="app-content" class="flex-1 relative">

        <!-- HOME -->
        <section id="page-home" class="page-section animate-fade-in">
            <div class="bg-gradient-to-b from-blue-50 to-white py-20 px-4">
                <div class="max-w-4xl mx-auto text-center space-y-6">
                    <div class="inline-flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-1.5 rounded-full text-sm font-semibold">
                        <i data-lucide="brain" class="w-4 h-4"></i> AI-Powered Health Assistant
                    </div>
                    <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 tracking-tight">
                        Clarity for your <span class="text-blue-600">health concerns.</span>
                    </h1>
                    <p class="text-lg md:text-xl text-slate-600 max-w-2xl mx-auto leading-relaxed">
                        PulseNova uses advanced AI to triage symptoms, analyze medical imaging, translate complex lab results, and check your pulse directly from your device.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center pt-4">
                        <button onclick="app.navigate('triage')" class="flex items-center justify-center gap-2 bg-blue-600 text-white px-8 py-4 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 hover:shadow-xl hover:-translate-y-0.5">
                            Start Symptom Check <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                        <button onclick="app.navigate('care')" class="flex items-center justify-center gap-2 bg-white text-slate-700 border border-slate-200 px-8 py-4 rounded-xl font-bold hover:bg-slate-50 transition-all">
                            Find Care Nearby
                        </button>
                    </div>
                </div>
            </div>

            <div class="py-20 px-4 max-w-6xl mx-auto">
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="bg-slate-50 w-14 h-14 rounded-xl flex items-center justify-center mb-4"><i data-lucide="message-square" class="w-8 h-8 text-indigo-500"></i></div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Smart Triage</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Interactive chat with voice & image support that understands symptoms.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="bg-slate-50 w-14 h-14 rounded-xl flex items-center justify-center mb-4"><i data-lucide="heart-pulse" class="w-8 h-8 text-red-500"></i></div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Pulse Check</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Check your estimated heart rate using just your phone's camera.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="bg-slate-50 w-14 h-14 rounded-xl flex items-center justify-center mb-4"><i data-lucide="file-image" class="w-8 h-8 text-emerald-500"></i></div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">X-Ray Analysis</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Upload scans for an instant summary of visible structures.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="bg-slate-50 w-14 h-14 rounded-xl flex items-center justify-center mb-4"><i data-lucide="map-pin" class="w-8 h-8 text-orange-500"></i></div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Care Finder</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Find hospitals, urgent care, pharmacies, dentists and more nearby.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRIAGE -->
        <section id="page-triage" class="page-section hidden h-[calc(100vh-64px)] p-4">
            <div class="max-w-4xl mx-auto h-full flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="font-semibold text-slate-700">Triage Assistant</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="app.toggleSpeechOutput()" id="btn-speech-toggle" class="p-2 rounded-full hover:bg-slate-200 text-slate-400 transition-colors" title="Toggle Voice Response">
                            <i data-lucide="volume-x" class="w-4 h-4"></i>
                        </button>
                        <button onclick="app.resetChat()" class="text-xs text-slate-500 hover:text-blue-600 underline">Reset Chat</button>
                    </div>
                </div>

                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50"></div>

                <div class="p-4 bg-white border-t border-slate-100 flex-shrink-0">
                    <div id="chat-image-preview-container" class="hidden mb-3 relative inline-block">
                        <img id="chat-image-preview" src="" alt="Preview" class="h-20 rounded-lg border border-slate-200 shadow-sm">
                        <button onclick="app.clearChatImage()" class="absolute -top-2 -right-2 bg-slate-800 text-white rounded-full p-1 hover:bg-red-500 transition-colors">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>

                    <div class="flex items-end gap-2">
                        <input type="file" id="chat-file-input" class="hidden" accept="image/*" onchange="app.handleChatImageSelect(this)">
                        <button onclick="document.getElementById('chat-file-input').click()" class="p-3 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors mb-[2px]">
                            <i data-lucide="image" class="w-5 h-5"></i>
                        </button>
                        <button onclick="app.openVoiceOverlay()" id="btn-mic" class="p-3 rounded-xl transition-all mb-[2px] text-slate-400 hover:text-blue-600 hover:bg-blue-50" title="Voice mode">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1 bg-slate-50 border border-slate-200 rounded-xl flex items-center px-4 py-2 focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <textarea id="chat-input" rows="1" placeholder="Type symptoms..." class="w-full bg-transparent border-none focus:outline-none text-slate-800 resize-none max-h-32 text-sm py-2 placeholder:text-slate-400" onkeydown="if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); app.sendMessage(); }"></textarea>
                        </div>
                        <button onclick="app.sendMessage()" id="btn-send" class="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20 mb-[2px]">
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="mt-2 text-[11px] text-slate-400">
                        Backend: <span class="font-mono">/api/triage</span> & <span class="font-mono">/api/vision</span> (Amazon Nova via Bedrock)
                    </div>
                </div>
            </div>
        </section>

        <!-- VITALS -->
        <section id="page-vitals" class="page-section hidden p-4 min-h-[calc(100vh-64px)]">
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-900 mb-2">Pulse Monitor</h1>
                    <p class="text-slate-500 text-sm">Measure your estimated heart rate using your device's camera.</p>
                </div>

                <div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-xl text-sm leading-relaxed flex gap-3 shadow-sm">
                    <i data-lucide="smartphone" class="w-5 h-5 shrink-0 mt-0.5"></i>
                    <div>
                        <p class="font-semibold mb-1">Best on phone (not laptop)</p>
                        <p class="text-amber-700">This feature works best on a smartphone with a rear camera. On laptops, pulse detection may be inaccurate or unavailable.</p>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-xl text-sm leading-relaxed flex gap-3 shadow-sm">
                    <i data-lucide="info" class="w-5 h-5 shrink-0 mt-0.5"></i>
                    <div>
                        <p class="font-semibold mb-1">How to use:</p>
                        <ul class="list-disc ml-4 space-y-1 text-blue-700">
                            <li>Place your fingertip gently over the <strong>back camera lens</strong>.</li>
                            <li>The flashlight will turn on automatically — hold steady.</li>
                            <li>Wait ~10 seconds. Monitoring stops automatically once a stable reading is found.</li>
                        </ul>
                        <p class="mt-2 text-xs opacity-80 border-t border-blue-200 pt-2"><strong>Privacy Note:</strong> Video processing happens entirely on your device. No video is recorded or sent to any server. Not a medical diagnostic tool.</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col items-center p-6">
                    <div class="w-full relative bg-slate-900 rounded-xl overflow-hidden mb-6 flex flex-col items-center justify-center min-h-[250px] shadow-inner">
                        <canvas id="ppg-graph" class="w-full h-40 opacity-80"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <div class="text-6xl font-bold text-white drop-shadow-md flex items-baseline gap-1">
                                <span id="bpm-display">--</span>
                                <span class="text-xl text-slate-300 font-normal">BPM</span>
                            </div>
                            <div id="vitals-status" class="text-sm text-slate-400 mt-2 bg-slate-900/60 px-3 py-1 rounded-full">Ready to start</div>
                        </div>
                        <video id="vitals-video" class="hidden" playsinline autoplay muted></video>
                    </div>

                    <!-- Signal quality bar -->
                    <div id="signal-quality-wrap" class="hidden w-full mb-4">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs text-slate-500">Signal Quality</span>
                            <span id="signal-quality-text" class="text-xs font-medium text-slate-600">Detecting...</span>
                        </div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div id="signal-quality-bar" class="h-full bg-green-400 rounded-full transition-all duration-500" style="width:0%"></div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="app.startVitals()" id="btn-start-vitals" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition-all shadow-md flex items-center gap-2">
                            <i data-lucide="play" class="w-5 h-5"></i> Start Monitor
                        </button>
                        <button onclick="app.stopVitals(false)" id="btn-stop-vitals" class="bg-slate-100 text-slate-700 border border-slate-300 px-8 py-3 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center gap-2 hidden">
                            <i data-lucide="square" class="w-5 h-5"></i> Stop
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- X-RAY -->
        <section id="page-xray" class="page-section hidden p-4 min-h-[calc(100vh-64px)]">
            <div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="scan-line" class="w-5 h-5 text-blue-600"></i> Image Upload
                        </h2>
                        <div onclick="document.getElementById('xray-input').click()"
                             id="xray-dropzone"
                             tabindex="0"
                             role="button"
                             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('xray-input').click();}"
                             class="border-2 border-dashed border-slate-300 hover:border-blue-400 hover:bg-slate-50 rounded-xl h-[400px] flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden relative">
                            <div id="xray-placeholder" class="text-center p-6">
                                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="upload" class="w-8 h-8 text-blue-600"></i>
                                </div>
                                <p class="font-semibold text-slate-700">Drag & drop or click to upload X-Ray/MRI</p>
                                <p class="text-sm text-slate-400 mt-2">JPG, PNG, HEIC image files</p>
                            </div>
                            <img id="xray-preview-img" class="hidden h-full w-full object-contain bg-slate-900" />
                            <input type="file" id="xray-input" class="hidden" accept="image/*" onchange="app.handleXrayUpload(this)">
                        </div>
                        <button onclick="app.analyzeXray()" id="btn-analyze-xray" disabled class="w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5"></i> Analyze Scan
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col h-[600px] lg:h-auto overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i> Medical Report
                        </h2>
                        <button onclick="window.print()" class="text-xs bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg font-medium hover:bg-slate-50 flex items-center gap-1 transition-colors">
                            <i data-lucide="printer" class="w-3 h-3"></i> Print
                        </button>
                    </div>
                    <div id="xray-result" class="flex-1 p-6 overflow-y-auto text-slate-700 prose prose-blue max-w-none">
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4 opacity-60">
                            <i data-lucide="file-image" class="w-16 h-16"></i>
                            <p class="text-center">Upload and scan an image to generate<br/>a detailed medical report.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- LABS -->
        <section id="page-labs" class="page-section hidden p-4 min-h-[calc(100vh-64px)]">
            <div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="microscope" class="w-5 h-5 text-purple-600"></i> Upload Lab Results
                        </h2>
                        <div onclick="document.getElementById('lab-input').click()"
                             id="lab-dropzone"
                             tabindex="0"
                             role="button"
                             onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('lab-input').click();}"
                             class="border-2 border-dashed border-slate-300 hover:border-purple-400 hover:bg-slate-50 rounded-xl h-[400px] flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden relative">
                            <div id="lab-placeholder" class="text-center p-6">
                                <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="upload" class="w-8 h-8 text-purple-600"></i>
                                </div>
                                <p class="font-semibold text-slate-700">Drag & drop or click to upload Report</p>
                                <p class="text-sm text-slate-400 mt-2">Blood Work, Urine Test, etc.</p>
                            </div>
                            <img id="lab-preview-img" class="hidden h-full w-full object-contain" />
                            <input type="file" id="lab-input" class="hidden" accept="image/*" onchange="app.handleLabUpload(this)">
                        </div>
                        <button onclick="app.analyzeLabs()" id="btn-analyze-lab" disabled class="w-full mt-4 bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5"></i> Translate Report
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col h-[600px] lg:h-auto overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-purple-600"></i> Interpretation
                        </h2>
                        <button onclick="window.print()" class="text-xs bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg font-medium hover:bg-slate-50 flex items-center gap-1 transition-colors">
                            <i data-lucide="printer" class="w-3 h-3"></i> Print
                        </button>
                    </div>
                    <div id="lab-result" class="flex-1 p-6 overflow-y-auto text-slate-700 prose prose-purple max-w-none">
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-4 opacity-60">
                            <i data-lucide="file-text" class="w-16 h-16"></i>
                            <p class="text-center">Upload a document to get a<br/>plain English explanation.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CARE FINDER -->
        <section id="page-care" class="page-section hidden p-4 animate-fade-in">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold text-slate-900 mb-2">Find Care Nearby</h1>
                    <p class="text-slate-500">Locate trusted medical providers in your area.</p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-4 flex flex-col gap-3">
                    <div class="grid md:grid-cols-12 gap-3">
                        <div class="md:col-span-6 relative">
                            <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="care-search" placeholder="City, address, or ZIP..." class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-3 relative">
                            <i data-lucide="filter" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="provider-filter" placeholder="Filter results..." oninput="app.renderProviders()" class="w-full pl-9 pr-3 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none">
                        </div>
                        <div class="md:col-span-3 flex gap-2">
                            <button onclick="app.searchCareByText()" id="btn-search-care" class="flex-1 px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-slate-700 hover:bg-slate-50 flex items-center gap-2 justify-center">
                                <i data-lucide="search" class="w-4 h-4"></i> Search
                            </button>
                            <button onclick="app.locateUser()" id="btn-locate" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 flex items-center gap-2 justify-center transition-colors">
                                <i data-lucide="navigation" class="w-4 h-4"></i> Near Me
                            </button>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-3">
                        <select id="care-filter" onchange="app.renderProviders()" class="px-4 py-2.5 border border-slate-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-500/20">
                            <option value="All">All Providers</option>
                            <option value="ER">Emergency Room</option>
                            <option value="Urgent Care">Urgent Care</option>
                            <option value="Hospital">Hospital</option>
                            <option value="Primary Care">Primary Care</option>
                            <option value="Clinic">Clinic</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Dentist">Dentist</option>
                            <option value="Pediatrician">Pediatrician</option>
                        </select>
                        <div id="care-status" class="text-sm text-slate-500 flex items-center" aria-live="polite"></div>
                    </div>
                </div>

                <div id="care-map-host" class="hidden h-1 w-1"></div>
                <div id="providers-list" class="grid md:grid-cols-2 gap-4"></div>
            </div>
        </section>

        <!-- ABOUT -->
        <section id="page-about" class="page-section hidden p-4 animate-fade-in">
            <div class="max-w-4xl mx-auto py-12">
                <div class="text-center mb-16">
                    <h1 class="text-3xl font-bold text-slate-900 mb-4">About PulseNova</h1>
                    <p class="text-slate-600 max-w-2xl mx-auto">
                        We are bridging the gap between uncertainty and care. PulseNova leverages cutting-edge AI to provide accessible, immediate medical information to everyone, everywhere.
                    </p>
                </div>
                <div class="space-y-12">
                    <div class="flex flex-col md:flex-row gap-8 items-center">
                        <div class="flex-1 space-y-4">
                            <div class="inline-block p-3 bg-blue-100 rounded-lg text-blue-700 mb-2"><i data-lucide="heart-pulse" class="w-6 h-6"></i></div>
                            <h2 class="text-2xl font-bold text-slate-800">Our Mission</h2>
                            <p class="text-slate-600 leading-relaxed">To reduce medical anxiety and ER overcrowding by providing an intelligent first-line triage tool. We believe everyone deserves to know "what to do next" the moment they feel unwell.</p>
                        </div>
                        <div class="flex-1 bg-slate-100 h-64 w-full rounded-2xl flex items-center justify-center overflow-hidden">
                            <img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&q=80&w=800" alt="Medical Team" class="w-full h-full object-cover opacity-90" />
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100"><h3 class="font-bold text-slate-900 mb-2">Accessibility</h3><p class="text-sm text-slate-600">Free, 24/7 access to medical guidance without insurance barriers.</p></div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100"><h3 class="font-bold text-slate-900 mb-2">Privacy</h3><p class="text-sm text-slate-600">We do not store your personal health data. Your chats are ephemeral.</p></div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100"><h3 class="font-bold text-slate-900 mb-2">Technology</h3><p class="text-sm text-slate-600">Powered by Amazon Nova (Bedrock) for text + vision and Google Maps Places for care discovery.</p></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ===== VOICE MODE OVERLAY ===== -->
    <div id="voice-overlay" class="voice-overlay flex-col">
        <!-- Top bar -->
        <div class="flex items-center justify-between p-5 flex-shrink-0">
            <div class="text-sm text-slate-300 flex items-center gap-2">
                <span id="voice-indicator-dot" class="w-2 h-2 rounded-full bg-slate-500 inline-block transition-colors duration-300"></span>
                <span id="voice-mode-label">Voice Mode</span>
            </div>
            <button onclick="app.closeVoiceMode()" class="text-slate-300 hover:text-white bg-white/10 px-3 py-2 rounded-xl text-sm flex items-center gap-1">
                <i data-lucide="x" class="w-4 h-4"></i> Close
            </button>
        </div>

        <!-- Center: Orb + rings + bars -->
        <div class="flex-1 flex flex-col items-center justify-center px-6 text-center">
            <div class="voice-orb-wrap mb-10">
                <div id="voice-orb" class="voice-orb state-idle"></div>
                <div class="voice-rings" id="voice-rings"></div>
            </div>

            <!-- Waveform bars -->
            <div id="voice-bars" class="voice-bars mb-6">
                <span id="vb1" style="height:6px"></span>
                <span id="vb2" style="height:6px"></span>
                <span id="vb3" style="height:6px"></span>
                <span id="vb4" style="height:6px"></span>
                <span id="vb5" style="height:6px"></span>
                <span id="vb6" style="height:6px"></span>
                <span id="vb7" style="height:6px"></span>
            </div>

            <!-- State title + subtitle -->
            <h2 id="voice-title" class="text-2xl font-bold text-white mb-2">Voice Mode</h2>
            <p id="voice-subtitle" class="text-slate-400 text-sm max-w-sm leading-relaxed">
                Tap <strong class="text-white">Start Listening</strong> to begin a hands-free conversation.
            </p>

            <!-- Transcript preview -->
            <div id="voice-transcript-preview" class="mt-5 text-sm text-slate-400 italic max-w-sm min-h-[20px]"></div>
        </div>

        <!-- Bottom: Primary action button -->
        <div class="p-6 flex-shrink-0">
            <div class="max-w-xs mx-auto">
                <button id="voice-main-btn"
                        onclick="app.voicePrimaryAction()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 transition-all">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                    <span id="voice-btn-label">Start Listening</span>
                </button>
                <p class="text-center text-xs text-slate-600 mt-3">Tap close to return to chat</p>
            </div>
        </div>
    </div>

    <script>
    // =====================================================================
    // PulseNova App — Full implementation with:
    //   - Voice mode loop (listen → send → speak → listen again)
    //   - Voice state machine (idle / listening / thinking / speaking)
    //   - Orb + bar animations synced to state
    //   - Barge-in (user speaks while bot is talking)
    //   - Vitals: torch on/off, signal quality, stable BPM detection, auto-stop
    //   - Care finder: filtered count fix
    // =====================================================================
    class PulseNovaApp {
        constructor() {
            this.messages = [
                { role: 'assistant', text: "Hello. I'm PulseNova. Please describe your symptoms in detail, or send me a photo if relevant." }
            ];

            this.chatImage   = null;
            this.xrayImage   = null;
            this.labImage    = null;
            this.chatBusy    = false;
            this.speakOutput = false;

            // ---- Voice mode state machine ----
            // States: 'idle' | 'listening' | 'thinking' | 'speaking'
            this.voiceState       = 'idle';
            this.voiceOverlayOpen = false;
            this.voiceLoopActive  = false;  // true when in continuous voice conversation
            this.recognition      = null;
            this.currentUtterance = null;
            this.voiceBarsAnimId  = null;
            this.barAnimPhase     = 0;

            // ---- Vitals ----
            this.vitals = {
                stream: null,
                video: null,
                canvas: null,
                ctx: null,
                processCanvas: document.createElement('canvas'),
                processCtx: null,
                animId: null,
                redValues: [],       // { time, val }
                smoothed: [],        // smoothed signal
                bpmHistory: [],      // recent valid BPM estimates
                stableBpmCount: 0,   // consecutive stable readings
                lastPeakTime: 0,
                isMonitoring: false,
                timeoutId: null,
                torchTrack: null,
                torchOn: false
            };
            this.vitals.processCanvas.width  = 20;
            this.vitals.processCanvas.height = 20;
            this.vitals.processCtx = this.vitals.processCanvas.getContext('2d', { willReadFrequently: true });
            this.processVitalsFrame = this.processVitalsFrame.bind(this);

            // ---- Google Maps ----
            this.googleMapsReady   = false;
            this.googleMapsLoading = null;
            this.gmap              = null;
            this.placesService     = null;
            this.geocoder          = null;
            this.providers         = [];
            this.care = { userLat: null, userLon: null, centerLabel: null };

            this.initSpeech();
            this.initCareSearch();
            this.initDropzones();
            this.renderChat();
            this.renderProviders();
            this.updateSpeechToggleUI();
        }

        // ================================================================
        // NAVIGATION
        // ================================================================
        navigate(pageId) {
            if (pageId !== 'vitals' && this.vitals.isMonitoring) this.stopVitals(false);

            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(el => {
                if (el.dataset.page === pageId) {
                    el.classList.add('bg-blue-50', 'text-blue-600');
                    el.classList.remove('text-slate-500');
                } else {
                    el.classList.remove('bg-blue-50', 'text-blue-600');
                    el.classList.add('text-slate-500');
                }
            });

            document.getElementById('mobile-menu').classList.add('hidden');

            if (pageId !== 'triage') {
                this.closeVoiceMode();
                window.speechSynthesis.cancel();
            }
        }

        toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        // ================================================================
        // VOICE MODE — STATE MACHINE
        // ================================================================
        // States: idle → listening → thinking → speaking → listening (loop)

        setVoiceState(state) {
            this.voiceState = state;
            const orb      = document.getElementById('voice-orb');
            const title    = document.getElementById('voice-title');
            const subtitle = document.getElementById('voice-subtitle');
            const dot      = document.getElementById('voice-indicator-dot');
            const btn      = document.getElementById('voice-main-btn');
            const btnLabel = document.getElementById('voice-btn-label');
            const bars     = document.getElementById('voice-bars');
            const preview  = document.getElementById('voice-transcript-preview');

            // Remove all state classes from orb
            if (orb) {
                orb.className = 'voice-orb';
                orb.classList.add(`state-${state}`);
            }

            // Update bars class
            if (bars) {
                bars.className = 'voice-bars';
                if (state === 'speaking') bars.classList.add('speaking');
                if (state === 'thinking') bars.classList.add('thinking');
            }

            switch (state) {
                case 'idle':
                    if (title)    title.textContent    = 'Voice Mode';
                    if (subtitle) subtitle.innerHTML   = 'Tap <strong class="text-white">Start Listening</strong> to begin.';
                    if (dot)      dot.className        = 'w-2 h-2 rounded-full bg-slate-500 inline-block transition-colors duration-300';
                    if (btn)      btn.className        = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 transition-all';
                    if (btnLabel) btnLabel.textContent = 'Start Listening';
                    if (btn)      btn.innerHTML        = '<i data-lucide="mic" class="w-5 h-5"></i><span id="voice-btn-label">Start Listening</span>';
                    this.voiceLoopActive = false;
                    this.stopBarAnimation();
                    this.resetBars();
                    break;

                case 'listening':
                    if (title)    title.textContent    = 'Listening...';
                    if (subtitle) subtitle.innerHTML   = 'Speak naturally. I\'m listening.';
                    if (dot)      dot.className        = 'w-2 h-2 rounded-full bg-blue-400 inline-block transition-colors duration-300 animate-pulse';
                    if (btn)      btn.innerHTML        = '<i data-lucide="mic-off" class="w-5 h-5"></i><span>Stop</span>';
                    if (btn)      btn.className        = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg transition-all';
                    if (preview)  preview.textContent  = '';
                    this.startBarAnimation('listening');
                    break;

                case 'thinking':
                    if (title)    title.textContent    = 'Thinking...';
                    if (subtitle) subtitle.innerHTML   = 'PulseNova is processing your message.';
                    if (dot)      dot.className        = 'w-2 h-2 rounded-full bg-purple-400 inline-block transition-colors duration-300';
                    if (btn)      btn.innerHTML        = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i><span>Processing...</span>';
                    if (btn)      btn.className        = 'w-full bg-slate-700 text-white font-semibold py-4 rounded-2xl flex items-center justify-center gap-2 opacity-70 cursor-not-allowed transition-all';
                    this.stopBarAnimation();
                    this.animateThinkingBars();
                    break;

                case 'speaking':
                    if (title)    title.textContent    = 'Speaking...';
                    if (subtitle) subtitle.innerHTML   = 'Speak to interrupt and ask again.';
                    if (dot)      dot.className        = 'w-2 h-2 rounded-full bg-emerald-400 inline-block transition-colors duration-300 animate-pulse';
                    if (btn)      btn.innerHTML        = '<i data-lucide="mic" class="w-5 h-5"></i><span>Interrupt</span>';
                    if (btn)      btn.className        = 'w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg transition-all';
                    this.startBarAnimation('speaking');
                    break;
            }
            lucide.createIcons();
        }

        // Bar animations
        startBarAnimation(mode) {
            this.stopBarAnimation();
            const barIds = ['vb1','vb2','vb3','vb4','vb5','vb6','vb7'];
            let frame = 0;
            const animate = () => {
                frame++;
                barIds.forEach((id, i) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    let h;
                    if (mode === 'listening') {
                        h = 6 + Math.abs(Math.sin(frame * 0.12 + i * 0.9)) * 30;
                    } else if (mode === 'speaking') {
                        h = 6 + Math.abs(Math.sin(frame * 0.18 + i * 1.2)) * 34;
                    } else {
                        h = 6;
                    }
                    el.style.height = h + 'px';
                });
                this.voiceBarsAnimId = requestAnimationFrame(animate);
            };
            this.voiceBarsAnimId = requestAnimationFrame(animate);
        }

        stopBarAnimation() {
            if (this.voiceBarsAnimId) {
                cancelAnimationFrame(this.voiceBarsAnimId);
                this.voiceBarsAnimId = null;
            }
        }

        animateThinkingBars() {
            // CSS handles thinking bar animation via .thinking class
        }

        resetBars() {
            ['vb1','vb2','vb3','vb4','vb5','vb6','vb7'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.height = '6px';
            });
        }

        // ================================================================
        // VOICE MODE — OPEN / CLOSE / PRIMARY ACTION
        // ================================================================
        initSpeech() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return;

            this.recognition = new SR();
            this.recognition.continuous = false;
            this.recognition.interimResults = true;
            this.recognition.lang = 'en-US';

            this.recognition.onstart = () => {
                this.setVoiceState('listening');
            };

            this.recognition.onresult = (event) => {
                let interim = '';
                let final   = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) final   += event.results[i][0].transcript;
                    else                          interim += event.results[i][0].transcript;
                }
                const preview = document.getElementById('voice-transcript-preview');
                if (preview) preview.textContent = `"${final || interim}"`;

                if (final.trim()) {
                    this._pendingTranscript = final.trim();
                }
            };

            this.recognition.onend = () => {
                // Only proceed if we're still in voice overlay and loop is active
                if (!this.voiceOverlayOpen) return;

                const transcript = this._pendingTranscript || '';
                this._pendingTranscript = '';

                if (transcript && this.voiceLoopActive) {
                    this._voiceSendAndReply(transcript);
                } else if (this.voiceLoopActive) {
                    // Nothing was said, go back to listening
                    this.setVoiceState('listening');
                    setTimeout(() => {
                        if (this.voiceState === 'listening' && this.voiceLoopActive) {
                            try { this.recognition.start(); } catch(e){}
                        }
                    }, 300);
                } else {
                    this.setVoiceState('idle');
                }
            };

            this.recognition.onerror = (e) => {
                console.warn('Speech recognition error:', e.error);
                if (e.error === 'aborted') return;
                // On error, go back to listening if loop is active
                if (this.voiceLoopActive && this.voiceOverlayOpen) {
                    setTimeout(() => {
                        if (this.voiceLoopActive && this.voiceOverlayOpen) {
                            this.setVoiceState('listening');
                            try { this.recognition.start(); } catch(err){}
                        }
                    }, 600);
                } else {
                    this.setVoiceState('idle');
                }
            };
        }

        openVoiceOverlay() {
            this.voiceOverlayOpen = true;
            const overlay = document.getElementById('voice-overlay');
            overlay.classList.add('show');
            this.setVoiceState('idle');
            lucide.createIcons();
        }

        closeVoiceMode() {
            this.voiceLoopActive  = false;
            this.voiceOverlayOpen = false;
            this._pendingTranscript = '';

            // Stop recognition
            if (this.recognition) {
                try { this.recognition.abort(); } catch (_) {}
            }

            // Stop speech
            window.speechSynthesis.cancel();
            if (this.currentUtterance) this.currentUtterance = null;

            this.stopBarAnimation();
            this.resetBars();

            const overlay = document.getElementById('voice-overlay');
            overlay.classList.remove('show');
        }

        // Called by button in voice overlay
        voicePrimaryAction() {
            if (this.voiceState === 'idle') {
                // Start the loop
                this.voiceLoopActive = true;
                this._startListening();
            } else if (this.voiceState === 'listening') {
                // User pressed stop
                this.voiceLoopActive = false;
                try { this.recognition.stop(); } catch(_) {}
                this.setVoiceState('idle');
            } else if (this.voiceState === 'speaking') {
                // Barge-in: interrupt bot and start listening
                window.speechSynthesis.cancel();
                this.setVoiceState('listening');
                setTimeout(() => {
                    try { this.recognition.start(); } catch(_) {}
                }, 200);
            } else if (this.voiceState === 'thinking') {
                // Can't interrupt thinking, do nothing
            }
        }

        _startListening() {
            if (!this.recognition) {
                alert("Your browser doesn't support speech recognition. Try Chrome.");
                return;
            }
            this.setVoiceState('listening');
            this._pendingTranscript = '';
            try {
                this.recognition.start();
            } catch (e) {
                console.warn('recognition.start error:', e);
                // Already started — retry after a moment
                setTimeout(() => {
                    try { this.recognition.start(); } catch (_) {}
                }, 500);
            }
        }

        async _voiceSendAndReply(text) {
            if (!text) return;

            // Show thinking state
            this.setVoiceState('thinking');
            const preview = document.getElementById('voice-transcript-preview');
            if (preview) preview.textContent = `You said: "${text}"`;

            // Add to chat (visible in background)
            this.messages.push({ role: 'user', text });
            this.renderChat();

            const history = this.messages.slice(0, -1).map(m => ({ role: m.role, text: m.text || '' }));
            const responseText = await this.callNovaTriage(history, text, null);

            this.messages.push({ role: 'assistant', text: responseText });
            this.renderChat();

            // Speak and loop
            this._voiceSpeak(responseText);
        }

        _voiceSpeak(text) {
            window.speechSynthesis.cancel();
            this.setVoiceState('speaking');

            // Ensure voices are loaded
            const voices = window.speechSynthesis.getVoices();
            const utter = new SpeechSynthesisUtterance(text.replace(/\*+/g, '').replace(/#{1,3}\s*/g, '').slice(0, 1500));
            utter.rate  = 1.0;
            utter.pitch = 1.0;

            // Pick a good English voice if available
            const preferred = voices.find(v => v.lang === 'en-US' && v.name.toLowerCase().includes('samantha'))
                           || voices.find(v => v.lang === 'en-US' && !v.name.toLowerCase().includes('google'))
                           || voices.find(v => v.lang.startsWith('en'));
            if (preferred) utter.voice = preferred;

            utter.onend = () => {
                if (!this.voiceOverlayOpen) return;
                if (this.voiceLoopActive) {
                    // Auto-loop: go back to listening
                    setTimeout(() => {
                        if (this.voiceLoopActive && this.voiceOverlayOpen) {
                            this._startListening();
                        }
                    }, 400);
                } else {
                    this.setVoiceState('idle');
                }
            };

            utter.onerror = () => {
                if (this.voiceLoopActive && this.voiceOverlayOpen) {
                    setTimeout(() => this._startListening(), 400);
                } else {
                    this.setVoiceState('idle');
                }
            };

            this.currentUtterance = utter;
            window.speechSynthesis.speak(utter);
        }

        // ================================================================
        // SPEECH TOGGLE (for text chat)
        // ================================================================
        updateSpeechToggleUI() {
            const btn = document.getElementById('btn-speech-toggle');
            if (!btn) return;
            if (this.speakOutput) {
                btn.classList.add('text-blue-600');
                btn.classList.remove('text-slate-400');
                btn.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4"></i>`;
            } else {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-slate-400');
                btn.innerHTML = `<i data-lucide="volume-x" class="w-4 h-4"></i>`;
            }
            lucide.createIcons();
        }

        toggleSpeechOutput() {
            this.speakOutput = !this.speakOutput;
            if (!this.speakOutput) window.speechSynthesis.cancel();
            this.updateSpeechToggleUI();
        }

        speak(text) {
            if (!this.speakOutput || !text) return;
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(text.replace(/\*+/g, '').slice(0, 1200));
            window.speechSynthesis.speak(utter);
        }

        // ================================================================
        // TRIAGE CHAT
        // ================================================================
        renderChat() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';

            this.messages.forEach(msg => {
                const isUser = msg.role === 'user';
                const div    = document.createElement('div');
                div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

                const wrapper = document.createElement('div');
                wrapper.className = 'max-w-[85%] space-y-2';

                if (msg.image) {
                    const imgWrap = document.createElement('div');
                    imgWrap.className = `p-2 rounded-2xl ${isUser ? 'bg-blue-600 rounded-tr-none' : 'bg-white border'}`;
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${msg.image}`;
                    img.className = 'max-h-48 rounded-lg object-cover';
                    img.alt = 'Uploaded image';
                    imgWrap.appendChild(img);
                    wrapper.appendChild(imgWrap);
                }

                if (msg.text) {
                    const bubble = document.createElement('div');
                    bubble.className = `rounded-2xl px-4 py-3 text-sm leading-relaxed ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none shadow-sm'}`;
                    bubble.innerHTML = this.formatText(msg.text);
                    wrapper.appendChild(bubble);
                }

                div.appendChild(wrapper);
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        async sendMessage() {
            if (this.chatBusy) return;
            const input = document.getElementById('chat-input');
            const text  = input.value.trim();
            const image = this.chatImage;
            if (!text && !image) return;

            this.chatBusy = true;
            const sendBtn = document.getElementById('btn-send');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-60');

            window.speechSynthesis.cancel();

            this.messages.push({ role: 'user', text, image });
            this.renderChat();
            input.value = '';
            this.clearChatImage();
            this.showLoading();

            const history      = this.messages.slice(0, -1).map(m => ({ role: m.role, text: m.text }));
            const responseText = await this.callNovaTriage(history, text, image);

            this.removeLoading();
            this.messages.push({ role: 'assistant', text: responseText });
            this.renderChat();

            if (this.speakOutput) this.speak(responseText);

            this.chatBusy = false;
            sendBtn.disabled = false;
            sendBtn.classList.remove('opacity-60');
        }

        showLoading() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'chat-loading';
            div.className = 'flex justify-start';
            div.innerHTML = `
                <div class="bg-white border border-slate-200 rounded-2xl rounded-tl-none px-4 py-4 shadow-sm flex gap-1 items-center h-10">
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        removeLoading() {
            const el = document.getElementById('chat-loading');
            if (el) el.remove();
        }

        handleChatImageSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                const fullData = reader.result;
                this.chatImage = fullData.split(',')[1];
                document.getElementById('chat-image-preview').src = fullData;
                document.getElementById('chat-image-preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        clearChatImage() {
            this.chatImage = null;
            document.getElementById('chat-image-preview').src = '';
            document.getElementById('chat-image-preview-container').classList.add('hidden');
            document.getElementById('chat-file-input').value = '';
        }

        resetChat() {
            window.speechSynthesis.cancel();
            this.messages = [{ role: 'assistant', text: "Hello. I'm PulseNova. Please describe your symptoms in detail." }];
            this.renderChat();
        }

        // ================================================================
        // NOVA BACKEND CALLS
        // ================================================================
        async callNovaTriage(history, userMessage, base64Image) {
            try {
                let cleanHistory = (history || [])
                    .map(t => ({ role: t.role, text: (t.text || '').trim() }))
                    .filter(t => t.text);
                while (cleanHistory.length && cleanHistory[0].role !== 'user') cleanHistory.shift();

                const payload = {
                    message: userMessage || "",
                    history: cleanHistory,
                    image_base64: base64Image || null
                };

                const res = await fetch('/api/triage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                return data.text || "I didn't get a response.";
            } catch (e) {
                console.error(e);
                return "I'm having trouble connecting. If this is an emergency, please call 911.";
            }
        }

        async callNovaVision(base64Data, prompt) {
            try {
                const payload = { image_base64: base64Data, prompt };
                const res = await fetch('/api/vision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${res.status}`);
                }
                const data = await res.json();
                return data.text || "I didn't get a response.";
            } catch (e) {
                console.error(e);
                return "Analysis failed. Please try a clearer image.";
            }
        }

        // ================================================================
        // VITALS — Improved with torch, signal quality, stable BPM
        // ================================================================
        async startVitals() {
            this.vitals.video  = document.getElementById('vitals-video');
            this.vitals.canvas = document.getElementById('ppg-graph');
            this.vitals.ctx    = this.vitals.canvas.getContext('2d');
            this.vitals.canvas.width  = this.vitals.canvas.offsetWidth  || 400;
            this.vitals.canvas.height = this.vitals.canvas.offsetHeight || 160;

            const statusEl = document.getElementById('vitals-status');
            const qualWrap = document.getElementById('signal-quality-wrap');

            try {
                statusEl.innerText = "Requesting camera...";

                this.vitals.stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' }, width: { ideal: 320 }, height: { ideal: 240 } }
                });

                this.vitals.video.srcObject = this.vitals.stream;
                await this.vitals.video.play();

                // Try to turn on torch (flashlight)
                const track = this.vitals.stream.getVideoTracks()[0];
                this.vitals.torchTrack = track;
                await this._setTorch(true);

                document.getElementById('btn-start-vitals').classList.add('hidden');
                document.getElementById('btn-stop-vitals').classList.remove('hidden');
                if (qualWrap) qualWrap.classList.remove('hidden');

                // Reset state
                this.vitals.isMonitoring  = true;
                this.vitals.redValues     = [];
                this.vitals.smoothed      = [];
                this.vitals.bpmHistory    = [];
                this.vitals.stableBpmCount = 0;
                this.vitals.lastPeakTime  = 0;
                statusEl.innerText = "Cover the lens with your fingertip...";
                statusEl.classList.add('text-amber-300');
                statusEl.classList.remove('text-red-400', 'text-green-400', 'text-slate-400');

                // Timeout after 20 seconds if no stable reading
                this.vitals.timeoutId = setTimeout(() => {
                    if (this.vitals.isMonitoring) {
                        statusEl.innerText = "No stable signal. Cover lens fully and hold still.";
                        this.stopVitals(false);
                    }
                }, 20000);

                this.processVitalsFrame();

            } catch (err) {
                console.error(err);
                statusEl.innerText = "Camera access denied or unavailable.";
                alert("Unable to access the camera. Please allow permissions and try again.");
            }
        }

        async _setTorch(on) {
            const track = this.vitals.torchTrack;
            if (!track) return;
            try {
                const caps = track.getCapabilities ? track.getCapabilities() : {};
                if (caps.torch) {
                    await track.applyConstraints({ advanced: [{ torch: on }] });
                    this.vitals.torchOn = on;
                }
            } catch (e) {
                console.warn("Torch not available:", e);
            }
        }

        stopVitals(autoStop = false) {
            this.vitals.isMonitoring = false;
            if (this.vitals.animId) cancelAnimationFrame(this.vitals.animId);
            if (this.vitals.timeoutId) clearTimeout(this.vitals.timeoutId);

            // Turn torch off
            this._setTorch(false).catch(() => {});

            if (this.vitals.stream) {
                this.vitals.stream.getTracks().forEach(t => t.stop());
                this.vitals.stream     = null;
                this.vitals.torchTrack = null;
            }

            document.getElementById('btn-stop-vitals').classList.add('hidden');
            document.getElementById('btn-start-vitals').classList.remove('hidden');

            const qualWrap = document.getElementById('signal-quality-wrap');
            if (qualWrap) qualWrap.classList.add('hidden');

            const statusEl = document.getElementById('vitals-status');
            statusEl.classList.remove('text-red-400', 'text-amber-300', 'animate-pulse');

            if (autoStop) {
                statusEl.innerText = "✓ Reading captured";
                statusEl.classList.add('text-green-400');
            } else {
                statusEl.innerText = "Stopped";
                statusEl.classList.add('text-slate-400');
            }

            if (this.vitals.ctx && this.vitals.canvas) {
                // Keep last waveform visible; don't clear
            }
        }

        processVitalsFrame() {
            if (!this.vitals.isMonitoring) return;

            const now = performance.now();
            this.vitals.processCtx.drawImage(this.vitals.video, 0, 0, 20, 20);
            const imageData = this.vitals.processCtx.getImageData(0, 0, 20, 20).data;

            let redSum = 0, greenSum = 0;
            const pixels = imageData.length / 4;
            for (let i = 0; i < imageData.length; i += 4) {
                redSum   += imageData[i];
                greenSum += imageData[i + 1];
            }
            const avgRed   = redSum   / pixels;
            const avgGreen = greenSum / pixels;

            // Signal quality: finger over lens = very high red, low green ratio
            const quality = Math.min(100, Math.max(0, ((avgRed - avgGreen) / 80) * 100));
            this._updateSignalQuality(quality);

            this.vitals.redValues.push({ time: now, val: avgRed });
            if (this.vitals.redValues.length > 240) this.vitals.redValues.shift();

            // Apply moving average smoothing (5-point)
            if (this.vitals.redValues.length >= 5) {
                const last5 = this.vitals.redValues.slice(-5).map(d => d.val);
                const smoothVal = last5.reduce((a, b) => a + b, 0) / 5;
                this.vitals.smoothed.push({ time: now, val: smoothVal });
                if (this.vitals.smoothed.length > 240) this.vitals.smoothed.shift();
            }

            // Only attempt BPM detection when signal quality is reasonable
            if (quality > 30 && this.vitals.smoothed.length > 30) {
                this.detectHeartbeat(now);
            } else if (quality <= 30) {
                const statusEl = document.getElementById('vitals-status');
                if (statusEl && this.vitals.redValues.length > 30) {
                    statusEl.innerText = "Cover lens fully with fingertip...";
                }
            }

            this.drawPPGGraph();
            this.vitals.animId = requestAnimationFrame(this.processVitalsFrame);
        }

        _updateSignalQuality(quality) {
            const bar  = document.getElementById('signal-quality-bar');
            const text = document.getElementById('signal-quality-text');
            if (!bar || !text) return;

            bar.style.width = quality + '%';
            if (quality < 25) {
                bar.className = 'h-full bg-red-400 rounded-full transition-all duration-500';
                text.textContent = 'Poor — cover lens more';
            } else if (quality < 60) {
                bar.className = 'h-full bg-yellow-400 rounded-full transition-all duration-500';
                text.textContent = 'Fair — hold still';
            } else {
                bar.className = 'h-full bg-green-400 rounded-full transition-all duration-500';
                text.textContent = 'Good signal';
            }
        }

        detectHeartbeat(now) {
            const data = this.vitals.smoothed;
            if (data.length < 40) return;

            // Adaptive threshold: mean + fraction of std dev
            const vals  = data.slice(-60).map(d => d.val);
            const mean  = vals.reduce((a, b) => a + b, 0) / vals.length;
            const std   = Math.sqrt(vals.reduce((a, b) => a + (b - mean) ** 2, 0) / vals.length);
            const threshold = mean + std * 0.6;

            const len  = data.length;
            const cur  = data[len - 1].val;
            const prev = data[len - 2].val;
            const prev2= data[len - 3].val;

            // Peak detection
            if (prev > cur && prev > prev2 && prev > threshold) {
                const minInterval = 350; // ~170 BPM max
                if (now - this.vitals.lastPeakTime > minInterval) {
                    const timeDiff = now - this.vitals.lastPeakTime;
                    if (this.vitals.lastPeakTime > 0 && timeDiff < 1500) {
                        const instantBPM = 60000 / timeDiff;
                        if (instantBPM >= 45 && instantBPM <= 180) {
                            this.vitals.bpmHistory.push(instantBPM);
                            if (this.vitals.bpmHistory.length > 8) this.vitals.bpmHistory.shift();

                            if (this.vitals.bpmHistory.length >= 4) {
                                const avgBPM = this.vitals.bpmHistory.reduce((a, b) => a + b, 0) / this.vitals.bpmHistory.length;
                                const bpmRange = Math.max(...this.vitals.bpmHistory) - Math.min(...this.vitals.bpmHistory);

                                document.getElementById('bpm-display').innerText = Math.round(avgBPM);

                                const statusEl = document.getElementById('vitals-status');
                                if (statusEl) {
                                    statusEl.innerText = "Detecting pulse...";
                                    statusEl.classList.add('text-red-400');
                                    statusEl.classList.remove('text-amber-300', 'text-slate-400');
                                }

                                // Stable: 5 consecutive readings within ±7 BPM
                                if (bpmRange <= 14 && this.vitals.bpmHistory.length >= 5) {
                                    this.vitals.stableBpmCount++;
                                    if (this.vitals.stableBpmCount >= 2) {
                                        // Stable reading confirmed — auto stop
                                        document.getElementById('bpm-display').innerText = Math.round(avgBPM);
                                        if (statusEl) statusEl.innerText = `✓ Stable: ${Math.round(avgBPM)} BPM`;
                                        clearTimeout(this.vitals.timeoutId);
                                        setTimeout(() => this.stopVitals(true), 800);
                                    }
                                } else {
                                    this.vitals.stableBpmCount = 0;
                                }
                            }
                        }
                    }
                    this.vitals.lastPeakTime = now;
                }
            }
        }

        drawPPGGraph() {
            const ctx  = this.vitals.ctx;
            const w    = this.vitals.canvas.width;
            const h    = this.vitals.canvas.height;
            const data = this.vitals.smoothed.length >= 5 ? this.vitals.smoothed : this.vitals.redValues;

            ctx.clearRect(0, 0, w, h);
            if (data.length < 2) return;

            let min = Infinity, max = -Infinity;
            for (const d of data) {
                if (d.val < min) min = d.val;
                if (d.val > max) max = d.val;
            }
            const range = max - min || 1;

            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth   = 2.5;
            ctx.lineJoin    = 'round';

            for (let i = 0; i < data.length; i++) {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((data[i].val - min) / range) * (h * 0.8) - (h * 0.1);
                if (i === 0) ctx.moveTo(x, y);
                else         ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        // ================================================================
        // X-RAY / LABS + DRAG DROP
        // ================================================================
        initDropzones() {
            this.setupDropzone('xray-dropzone', 'xray-input', (file) => this.handleDroppedFile(file, 'xray'));
            this.setupDropzone('lab-dropzone',  'lab-input',  (file) => this.handleDroppedFile(file, 'lab'));
        }

        setupDropzone(dropId, inputId, onFile) {
            const zone = document.getElementById(dropId);
            if (!zone) return;

            ['dragenter', 'dragover'].forEach(evt => {
                zone.addEventListener(evt, (e) => {
                    e.preventDefault(); e.stopPropagation();
                    zone.classList.add(dropId.includes('lab') ? 'drag-active-purple' : 'drag-active');
                });
            });
            ['dragleave', 'drop'].forEach(evt => {
                zone.addEventListener(evt, (e) => {
                    e.preventDefault(); e.stopPropagation();
                    zone.classList.remove('drag-active', 'drag-active-purple');
                });
            });
            zone.addEventListener('drop', (e) => {
                const file = e.dataTransfer?.files?.[0];
                if (file) onFile(file);
            });
        }

        handleDroppedFile(file, type) {
            const fakeInput = { files: [file] };
            if (type === 'xray') this.handleXrayUpload(fakeInput);
            else                 this.handleLabUpload(fakeInput);
        }

        handleXrayUpload(input) { this.handleFileUpload(input, 'xray'); }
        handleLabUpload(input)  { this.handleFileUpload(input, 'lab');  }

        handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { alert("Please upload an image file."); return; }

            const reader = new FileReader();
            reader.onloadend = () => {
                const fullData = reader.result;
                const base64   = fullData.split(',')[1];
                if (type === 'xray') {
                    this.xrayImage = base64;
                    const img = document.getElementById('xray-preview-img');
                    img.src = fullData; img.classList.remove('hidden');
                    document.getElementById('xray-placeholder').classList.add('hidden');
                    document.getElementById('btn-analyze-xray').disabled = false;
                } else {
                    this.labImage = base64;
                    const img = document.getElementById('lab-preview-img');
                    img.src = fullData; img.classList.remove('hidden');
                    document.getElementById('lab-placeholder').classList.add('hidden');
                    document.getElementById('btn-analyze-lab').disabled = false;
                }
            };
            reader.readAsDataURL(file);
        }

        async analyzeXray() {
            if (!this.xrayImage) return;
            const btn = document.getElementById('btn-analyze-xray');
            btn.disabled = true;
            btn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Running...`;

            const prompt = `Analyze this X-Ray/MRI image carefully.
Output format:
### 🏥 Summary
[1-2 sentences]
### 🦴 Findings
- **Anatomy:** ...
- **Observations:** ...
### 🩺 Next Steps
[Practical next steps]
***
*DISCLAIMER: Not a diagnosis.*`;

            const text = await this.callNovaVision(this.xrayImage, prompt);
            document.getElementById('xray-result').innerHTML = this.formatMarkdown(text);
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="activity" class="w-5 h-5"></i> Analyze Scan`;
            lucide.createIcons();
        }

        async analyzeLabs() {
            if (!this.labImage) return;
            const btn = document.getElementById('btn-analyze-lab');
            btn.disabled = true;
            btn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Translating...`;

            const prompt = `Analyze this medical lab report image.
Output format:
### 🩸 Summary
[1-2 sentences]
### 🔍 Key Findings
- **[Test Name]:** [Value] — [Plain English meaning]
### ⚠️ Flags
[Anything out of range, if visible]
### 📋 Next Steps
[Practical next steps]
***
*DISCLAIMER: Not a diagnosis.*`;

            const text = await this.callNovaVision(this.labImage, prompt);
            document.getElementById('lab-result').innerHTML = this.formatMarkdown(text);
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="activity" class="w-5 h-5"></i> Translate Report`;
            lucide.createIcons();
        }

        // ================================================================
        // CARE FINDER
        // ================================================================
        async ensureGoogleMaps() {
            if (this.googleMapsReady) return;
            if (this.googleMapsLoading) return this.googleMapsLoading;

            this.googleMapsLoading = new Promise(async (resolve, reject) => {
                try {
                    if (window.google?.maps?.places) {
                        this.googleMapsReady = true;
                        this.initGoogleServices();
                        resolve(); return;
                    }
                    const cfgRes = await fetch('/config');
                    if (!cfgRes.ok) throw new Error(`Failed to fetch /config (${cfgRes.status})`);
                    const cfg    = await cfgRes.json();
                    const apiKey = cfg.google_maps_api_key;
                    if (!apiKey) throw new Error("GOOGLE_MAPS_API_KEY is not set on the server.");

                    window.__pulseNovaMapsInit = () => {
                        this.googleMapsReady = true;
                        try { this.initGoogleServices(); resolve(); }
                        catch (e) { reject(e); }
                        finally { try { delete window.__pulseNovaMapsInit; } catch (_) {} }
                    };

                    if (document.getElementById('pulse-nova-gmaps')) return;
                    const script = document.createElement('script');
                    script.id  = 'pulse-nova-gmaps';
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places,geometry&callback=__pulseNovaMapsInit&loading=async`;
                    script.async = true; script.defer = true;
                    script.onerror = () => reject(new Error("Failed to load Google Maps JS SDK"));
                    document.head.appendChild(script);
                } catch (err) { reject(err); }
            });
            return this.googleMapsLoading;
        }

        initGoogleServices() {
            if (this.gmap) return;
            const host = document.getElementById('care-map-host');
            this.gmap = new google.maps.Map(host, { center: { lat: 41.7658, lng: -72.6734 }, zoom: 12, disableDefaultUI: true });
            this.placesService = new google.maps.places.PlacesService(this.gmap);
            this.geocoder      = new google.maps.Geocoder();
        }

        setCareStatus(text, isError = false) {
            const el = document.getElementById('care-status');
            if (!el) return;
            el.textContent = text || "";
            el.className = `text-sm flex items-center ${isError ? 'text-red-600' : 'text-slate-500'}`;
        }

        initCareSearch() {
            const input = document.getElementById('care-search');
            if (!input) return;
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); this.searchCareByText(); }
            });
        }

        async searchCareByText() {
            const input = document.getElementById('care-search');
            const query = (input?.value || '').trim();
            const btn   = document.getElementById('btn-search-care');
            if (!query) { this.setCareStatus("Enter a city or ZIP code.", true); return; }

            try {
                btn.disabled = true; btn.classList.add('opacity-70');
                this.setCareStatus("Finding area...");
                await this.ensureGoogleMaps();

                const geo = await new Promise((resolve, reject) => {
                    this.geocoder.geocode({ address: query }, (results, status) => {
                        if (status === "OK" && results?.length) resolve(results[0]);
                        else reject(new Error(`Geocoding failed: ${status}`));
                    });
                });

                const loc = geo.geometry.location;
                this.care.userLat   = loc.lat();
                this.care.userLon   = loc.lng();
                this.care.centerLabel = geo.formatted_address || query;
                if (this.gmap) { this.gmap.setCenter({ lat: this.care.userLat, lng: this.care.userLon }); this.gmap.setZoom(12); }
                await this.fetchNearbyProviders(this.care.userLat, this.care.userLon);
            } catch (err) {
                console.error(err);
                this.setCareStatus("Could not search this area. Try another city/ZIP.", true);
            } finally {
                btn.disabled = false; btn.classList.remove('opacity-70');
            }
        }

        async locateUser() {
            const btn = document.getElementById('btn-locate');
            const orig = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'Locating...';
            this.setCareStatus("Requesting your location...");

            try {
                await this.ensureGoogleMaps();
                const pos = await new Promise((resolve, reject) => {
                    if (!navigator.geolocation) { reject(new Error("Geolocation not supported.")); return; }
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000 });
                });
                this.care.userLat   = pos.coords.latitude;
                this.care.userLon   = pos.coords.longitude;
                this.care.centerLabel = "your location";
                await this.fetchNearbyProviders(this.care.userLat, this.care.userLon);
            } catch (e) {
                console.error(e);
                this.setCareStatus("Couldn't get location. Try Search with ZIP/city.", true);
            } finally {
                btn.disabled = false; btn.innerHTML = orig;
                lucide.createIcons();
            }
        }

        nearbySearchPromise(request) {
            return new Promise((resolve, reject) => {
                this.placesService.nearbySearch(request, (results, status) => {
                    const ok = google.maps.places.PlacesServiceStatus;
                    if (status === ok.OK || status === ok.ZERO_RESULTS) resolve(results || []);
                    else reject(new Error(`Places search failed: ${status}`));
                });
            });
        }

        textSearchPromise(request) {
            return new Promise((resolve, reject) => {
                this.placesService.textSearch(request, (results, status) => {
                    const ok = google.maps.places.PlacesServiceStatus;
                    if (status === ok.OK || status === ok.ZERO_RESULTS) resolve(results || []);
                    else reject(new Error(`Places text search failed: ${status}`));
                });
            });
        }

        getDistanceMiles(lat1, lon1, lat2, lon2) {
            if (window.google?.maps?.geometry?.spherical) {
                const a = new google.maps.LatLng(lat1, lon1);
                const b = new google.maps.LatLng(lat2, lon2);
                return google.maps.geometry.spherical.computeDistanceBetween(a, b) / 1609.344;
            }
            const R = 6371000, toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) / 1609.344;
        }

        normalizePlace(place, inferredType) {
            const loc  = place.geometry?.location;
            const lat  = typeof loc?.lat === 'function' ? loc.lat() : loc?.lat;
            const lon  = typeof loc?.lng === 'function' ? loc.lng() : loc?.lng;
            const name = (place.name || '').toLowerCase();
            const types = place.types || [];

            let type = inferredType || 'Clinic';
            if (types.includes('hospital'))  type = inferredType === 'Urgent Care' ? 'Urgent Care' : 'Hospital';
            if (types.includes('pharmacy'))  type = 'Pharmacy';
            if (types.includes('dentist'))   type = 'Dentist';
            if (name.includes('urgent care')) type = 'Urgent Care';
            if (name.includes('pediatric'))   type = 'Pediatrician';
            if (name.includes('primary care') || name.includes('family medicine')) type = 'Primary Care';
            if (type === 'Hospital' && (name.includes('emergency') || name.includes(' er '))) type = 'ER';

            const distance = (this.care.userLat != null && lat != null)
                ? this.getDistanceMiles(this.care.userLat, this.care.userLon, lat, lon)
                : null;

            return {
                id: place.place_id,
                name: place.name || "Unknown provider",
                type,
                address: place.vicinity || place.formatted_address || "Address unavailable",
                rating: place.rating || null,
                distance, lat, lon, placeId: place.place_id
            };
        }

        dedupeProviders(list) {
            const seen = new Map();
            for (const p of list) {
                if (!p?.id) continue;
                if (!seen.has(p.id)) seen.set(p.id, p);
                else if (seen.get(p.id).type === 'Hospital' && p.type === 'Urgent Care') seen.set(p.id, p);
            }
            return Array.from(seen.values());
        }

        async fetchNearbyProviders(lat, lon) {
            this.setCareStatus("Searching nearby care options...");
            this.providers = [];
            this.renderProviders();

            try {
                const center = new google.maps.LatLng(lat, lon);
                this.gmap.setCenter(center);

                const radius = 12000;
                const [hospitals, pharmacies, dentists, urgentCare, primaryCare, pediatrics] = await Promise.all([
                    this.nearbySearchPromise({ location: center, radius, type: 'hospital' }),
                    this.nearbySearchPromise({ location: center, radius, type: 'pharmacy' }),
                    this.nearbySearchPromise({ location: center, radius, type: 'dentist' }),
                    this.textSearchPromise({ location: center, radius, query: 'urgent care' }),
                    this.textSearchPromise({ location: center, radius, query: 'primary care clinic' }),
                    this.textSearchPromise({ location: center, radius, query: 'pediatrician' })
                ]);

                let merged = [
                    ...hospitals.map(p  => this.normalizePlace(p, 'Hospital')),
                    ...pharmacies.map(p => this.normalizePlace(p, 'Pharmacy')),
                    ...dentists.map(p   => this.normalizePlace(p, 'Dentist')),
                    ...urgentCare.map(p => this.normalizePlace(p, 'Urgent Care')),
                    ...primaryCare.map(p=> this.normalizePlace(p, 'Primary Care')),
                    ...pediatrics.map(p => this.normalizePlace(p, 'Pediatrician'))
                ];

                merged = this.dedupeProviders(merged);
                merged.sort((a, b) => ((a.distance ?? 999) - (b.distance ?? 999)));
                this.providers = merged.slice(0, 30);

                // Reset type filter to "All" so results are visible by default
                const filterEl = document.getElementById('care-filter');
                if (filterEl) filterEl.value = 'All';
                const textEl = document.getElementById('provider-filter');
                if (textEl) textEl.value = '';

                this.renderProviders();

                const visible = this.getFilteredProviders().length;
                const label   = this.care.centerLabel ? ` near ${this.care.centerLabel}` : "";
                this.setCareStatus(
                    this.providers.length
                        ? `Found ${this.providers.length} providers${label}. Showing ${visible}.`
                        : `No providers found${label}. Try another ZIP/city.`
                );
            } catch (e) {
                console.error(e);
                this.setCareStatus("Care search failed. Check your Maps API key and enabled APIs.", true);
            }
        }

        getFilteredProviders() {
            const typeFilter = document.getElementById('care-filter')?.value || 'All';
            const textFilter = (document.getElementById('provider-filter')?.value || '').trim().toLowerCase();
            let filtered = this.providers.slice();
            if (typeFilter !== 'All') filtered = filtered.filter(p => p.type === typeFilter);
            if (textFilter) filtered = filtered.filter(p =>
                (p.name || '').toLowerCase().includes(textFilter) ||
                (p.address || '').toLowerCase().includes(textFilter)
            );
            return filtered;
        }

        renderProviders() {
            const list = document.getElementById('providers-list');
            if (!list) return;
            list.innerHTML = '';

            const filtered = this.getFilteredProviders();

            if (!filtered.length) {
                list.innerHTML = `
                    <div class="col-span-full bg-white border border-slate-200 rounded-2xl p-6 text-center text-slate-500">
                        No visible providers. Use <strong>Near Me</strong> or search a city/ZIP.
                        <div class="text-xs text-slate-400 mt-2">If you already searched, clear the filter box or change the type selector.</div>
                    </div>`;
                return;
            }

            filtered.forEach(p => {
                const colorClass =
                    p.type === 'ER'          ? 'bg-red-100 text-red-700' :
                    p.type === 'Urgent Care' ? 'bg-blue-100 text-blue-700' :
                    p.type === 'Hospital'    ? 'bg-orange-100 text-orange-700' :
                    p.type === 'Pharmacy'    ? 'bg-green-100 text-green-700' :
                    p.type === 'Dentist'     ? 'bg-purple-100 text-purple-700' :
                    p.type === 'Primary Care'? 'bg-cyan-100 text-cyan-700' :
                    p.type === 'Pediatrician'? 'bg-pink-100 text-pink-700' :
                    'bg-slate-100 text-slate-700';

                const distText = typeof p.distance === 'number' ? p.distance.toFixed(1) : '--';
                const ratingText = p.rating ? `${p.rating}` : 'N/A';

                const directionsUrl = (p.lat != null && p.lon != null)
                    ? `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}`
                    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name + ' ' + p.address)}`;

                list.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex justify-between items-start gap-3">
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-xs font-bold px-2 py-1 rounded-md ${colorClass}">${this.escapeHtml(p.type)}</span>
                                <span class="text-xs text-slate-400 flex items-center gap-0.5"><span class="text-yellow-400">★</span> ${this.escapeHtml(ratingText)}</span>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg leading-tight">${this.escapeHtml(p.name)}</h3>
                            <p class="text-slate-500 text-sm mb-3">${this.escapeHtml(p.address)}</p>
                            <div class="flex gap-2 flex-wrap">
                                <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer"
                                   class="text-xs bg-slate-50 text-slate-600 px-3 py-1.5 rounded-lg border border-slate-200 font-medium hover:bg-slate-100 flex items-center gap-1">
                                    <i data-lucide="map" class="w-3 h-3"></i> Open Map
                                </a>
                                <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer"
                                   class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg border border-blue-100 font-medium hover:bg-blue-100 flex items-center gap-1">
                                    <i data-lucide="navigation" class="w-3 h-3"></i> Directions
                                </a>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <span class="block text-xl font-bold text-slate-900">${this.escapeHtml(distText)}</span>
                            <span class="text-xs text-slate-400">miles</span>
                        </div>
                    </div>`;
            });

            lucide.createIcons();
        }

        // ================================================================
        // UTILS
        // ================================================================
        escapeHtml(str) {
            return String(str ?? '')
                .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        formatText(text) {
            return this.escapeHtml(text || '').replace(/\n/g, '<br>');
        }

        formatMarkdown(text) {
            const safe = this.escapeHtml(text || '');
            let html = safe
                .replace(/^### (.*)$/gm, '<h3 class="text-lg font-bold text-blue-800 mt-4 mb-2">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<span class="font-semibold text-slate-900">$1</span>')
                .replace(/^\- (.*)$/gm, '<li class="ml-4 list-disc mb-1">$1</li>')
                .replace(/\*DISCLAIMER:(.*)\*/g, '<p class="text-xs text-slate-500 italic mt-4 border-t pt-2">$1</p>')
                .replace(/\n/g, '<br>');
            if (html.includes('<li')) {
                html = html.replace(/(<li[\s\S]*?<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul><br><ul>/g, '');
            }
            return html;
        }
    }

    // Init
    const app = new PulseNovaApp();

    // Preload voices on user interaction (fixes iOS/browser TTS quirk)
    document.addEventListener('click', () => {
        if (window.speechSynthesis && window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.getVoices();
        }
    }, { once: true });

    lucide.createIcons();
    </script>
</body>
</html>
